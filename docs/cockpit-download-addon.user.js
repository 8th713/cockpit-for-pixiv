/*
// ==UserScript==
// @name         cockpit download addon
// @description  cockpit download helper addon.
// @version      4.0.4
// @author       8th713
// @homepage     https://github.com/8th713/cockpit-for-pixiv
// @supportURL   https://github.com/8th713/cockpit-for-pixiv/issues
// @license      MIT
// @namespace    http://github.com/8th713
// @match        https://www.pixiv.net/*
// @exclude      https://www.pixiv.net/novel/*
// @exclude      https://www.pixiv.net/member_illust.php?mode*
// @grant        unsafeWindow
// @grant        GM_xmlhttpRequest
// @connect      i.pximg.net
// @connect      pixiv.net
// ==/UserScript==
*/!function(t){var e={};function r(n){if(e[n])return e[n].exports;var o=e[n]={i:n,l:!1,exports:{}};return t[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}r.m=t,r.c=e,r.d=function(t,e,n){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},r.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"===typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)r.d(n,o,function(e){return t[e]}.bind(null,o));return n},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=17)}({1:function(t,e,r){"use strict";var n=function(){return(n=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var o in e=arguments[r])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)},o=function(){for(var t=0,e=0,r=arguments.length;e<r;e++)t+=arguments[e].length;var n=Array(t),o=0;for(e=0;e<r;e++)for(var i=arguments[e],s=0,a=i.length;s<a;s++,o++)n[o]=i[s];return n},i=function(t,e,r){if(void 0===r&&(r=!1),!t||!e||"object"!==typeof t||"object"!==typeof e)return t;var s=n({},t);for(var a in e)e.hasOwnProperty(a)&&(e[a]instanceof Array&&t[a]instanceof Array?s[a]=r?o(t[a],e[a]):e[a]:"object"===typeof e[a]&&"object"===typeof t[a]?s[a]=i(t[a],e[a],r):s[a]=e[a]);return s},s=function(){for(var t=0,e=0,r=arguments.length;e<r;e++)t+=arguments[e].length;var n=Array(t),o=0;for(e=0;e<r;e++)for(var i=arguments[e],s=0,a=i.length;s<a;s++,o++)n[o]=i[s];return n},a={defaults:{},errorType:null,polyfills:{fetch:null,FormData:null,URLSearchParams:null,performance:null,PerformanceObserver:null,AbortController:null},polyfill:function(t,e){for(var r=void 0===e?{}:e,n=r.doThrow,o=void 0===n||n,i=r.instance,a=void 0!==i&&i,u=[],c=2;c<arguments.length;c++)u[c-2]=arguments[c];var l=this.polyfills[t]||("undefined"!==typeof self?self[t]:null)||("undefined"!==typeof global?global[t]:null);if(o&&!l)throw new Error(t+" is not defined");return a&&l?new(l.bind.apply(l,s([void 0],u))):l}},u=function(t,e,r,n){if(!t.getEntriesByName)return!1;var o=t.getEntriesByName(e);return!!(o&&o.length>0)&&(r(o.reverse()[0]),n.clearMeasures&&n.clearMeasures(e),c.callbacks.delete(e),c.callbacks.size<1&&(c.observer.disconnect(),n.clearResourceTimings&&n.clearResourceTimings()),!0)},c={callbacks:new Map,observer:null,observe:function(t,e){if(t&&e){var r=a.polyfill("performance",{doThrow:!1});(function(t,e){return!c.observer&&t&&e&&(c.observer=new e((function(e){c.callbacks.forEach((function(r,n){u(e,n,r,t)}))})),t.clearResourceTimings&&t.clearResourceTimings()),c.observer})(r,a.polyfill("PerformanceObserver",{doThrow:!1}))&&(u(r,t,e,r)||(c.callbacks.size<1&&c.observer.observe({entryTypes:["resource","measure"]}),c.callbacks.set(t,e)))}}},l=c,f=function(){return(f=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var o in e=arguments[r])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)},p=function(){for(var t=0,e=0,r=arguments.length;e<r;e++)t+=arguments[e].length;var n=Array(t),o=0;for(e=0;e<r;e++)for(var i=arguments[e],s=0,a=i.length;s<a;s++,o++)n[o]=i[s];return n},d=function(){function t(t,e,r,n,o,i){void 0===r&&(r=new Map),void 0===n&&(n=[]),void 0===o&&(o=[]),void 0===i&&(i=[]),this._url=t,this._options=e,this._catchers=r,this._resolvers=n,this._middlewares=o,this._deferredChain=i}return t.factory=function(e,r){return void 0===e&&(e=""),void 0===r&&(r={}),new t(e,r)},t.prototype.selfFactory=function(e){var r=void 0===e?{}:e,n=r.url,o=void 0===n?this._url:n,i=r.options,s=void 0===i?this._options:i,a=r.catchers,u=void 0===a?this._catchers:a,c=r.resolvers,l=void 0===c?this._resolvers:c,d=r.middlewares,h=void 0===d?this._middlewares:d,y=r.deferredChain,v=void 0===y?this._deferredChain:y;return new t(o,f({},s),new Map(u),p(l),p(h),p(v))},t.prototype.defaults=function(t,e){return void 0===e&&(e=!1),a.defaults=e?i(a.defaults,t):t,this},t.prototype.errorType=function(t){return a.errorType=t,this},t.prototype.polyfills=function(t){return a.polyfills=f(f({},a.polyfills),t),this},t.prototype.url=function(t,e){if(void 0===e&&(e=!1),e)return this.selfFactory({url:t});var r=this._url.split("?");return this.selfFactory({url:r.length>1?r[0]+t+"?"+r[1]:this._url+t})},t.prototype.options=function(t,e){return void 0===e&&(e=!0),this.selfFactory({options:e?i(this._options,t):t})},t.prototype.query=function(t,e){return void 0===e&&(e=!1),this.selfFactory({url:h(this._url,t,e)})},t.prototype.headers=function(t){return this.selfFactory({options:i(this._options,{headers:t||{}})})},t.prototype.accept=function(t){return this.headers({Accept:t})},t.prototype.content=function(t){return this.headers({"Content-Type":t})},t.prototype.auth=function(t){return this.headers({Authorization:t})},t.prototype.catcher=function(t,e){var r=new Map(this._catchers);return r.set(t,e),this.selfFactory({catchers:r})},t.prototype.signal=function(t){return this.selfFactory({options:f(f({},this._options),{signal:t.signal})})},t.prototype.resolve=function(t,e){return void 0===e&&(e=!1),this.selfFactory({resolvers:e?[t]:p(this._resolvers,[t])})},t.prototype.defer=function(t,e){return void 0===e&&(e=!1),this.selfFactory({deferredChain:e?[t]:p(this._deferredChain,[t])})},t.prototype.middlewares=function(t,e){return void 0===e&&(e=!1),this.selfFactory({middlewares:e?t:p(this._middlewares,t)})},t.prototype.method=function(t,e,r){void 0===e&&(e={}),void 0===r&&(r=null);var n=r?"object"===typeof r?this.json(r):this.body(r):this;return function(t){var e=t._url,r=t._catchers,n=t._resolvers,o=t._middlewares,s=t._options,u=new Map(r),c=i(a.defaults,s),f=a.polyfill("AbortController",{doThrow:!1,instance:!0});!c.signal&&f&&(c.signal=f.signal);var p={ref:null,clear:function(){p.ref&&(clearTimeout(p.ref),p.ref=null)}},d=function(t){return function(e){return 0===t.length?e:1===t.length?t[0](e):t.reduceRight((function(r,n,o){return o===t.length-2?n(r(e)):n(r)}))}}(o)(a.polyfill("fetch"))(e,c),h=d.then((function(t){return p.clear(),t.ok?t:t[a.errorType||"text"]().then((function(e){var r=new Error(e);throw r[a.errorType||"text"]=e,r.status=t.status,r.response=t,r}))})),y=function(e){return e.catch((function(e){if(p.clear(),u.has(e.status))return u.get(e.status)(e,t);if(u.has(e.name))return u.get(e.name)(e,t);throw e}))},v=function(t){return function(e){return y(t?h.then((function(e){return e&&e[t]()})).then((function(t){return e?e(t):t})):h.then((function(t){return e?e(t):t})))}},b={res:v(null),json:v("json"),blob:v("blob"),formData:v("formData"),arrayBuffer:v("arrayBuffer"),text:v("text"),perfs:function(t){return d.then((function(e){return l.observe(e.url,t)})),b},setTimeout:function(t,e){return void 0===e&&(e=f),p.clear(),p.ref=setTimeout((function(){return e.abort()}),t),b},controller:function(){return[f,b]},error:function(t,e){return u.set(t,e),b},badRequest:function(t){return b.error(400,t)},unauthorized:function(t){return b.error(401,t)},forbidden:function(t){return b.error(403,t)},notFound:function(t){return b.error(404,t)},timeout:function(t){return b.error(408,t)},internalError:function(t){return b.error(500,t)},onAbort:function(t){return b.error("AbortError",t)}};return n.reduce((function(e,r){return r(e,t)}),b)}((n=n.options(f(f({},e),{method:t})))._deferredChain.reduce((function(t,e){return e(t,t._url,t._options)}),n))},t.prototype.get=function(t){return this.method("GET",t)},t.prototype.delete=function(t){return this.method("DELETE",t)},t.prototype.put=function(t,e){return this.method("PUT",e,t)},t.prototype.post=function(t,e){return this.method("POST",e,t)},t.prototype.patch=function(t,e){return this.method("PATCH",e,t)},t.prototype.head=function(t){return this.method("HEAD",t)},t.prototype.opts=function(t){return this.method("OPTIONS",t)},t.prototype.replay=function(t){return this.method(this._options.method,t)},t.prototype.body=function(t){return this.selfFactory({options:f(f({},this._options),{body:t})})},t.prototype.json=function(t){return this.content("application/json").body(JSON.stringify(t))},t.prototype.formData=function(t){return this.body(function(t){var e=a.polyfill("FormData",{instance:!0});for(var r in t)if(t[r]instanceof Array)for(var n=0,o=t[r];n<o.length;n++){var i=o[n];e.append(r+"[]",i)}else e.append(r,t[r]);return e}(t))},t.prototype.formUrl=function(t){return this.body("string"===typeof t?t:(e=t,Object.keys(e).map((function(t){var r=e[t];return r instanceof Array?r.map((function(e){return y(t,e)})).join("&"):y(t,r)})).join("&"))).content("application/x-www-form-urlencoded");var e},t}(),h=function(t,e,r){var n;if("string"===typeof e)n=e;else{var o=a.polyfill("URLSearchParams",{instance:!0});for(var i in e)if(e[i]instanceof Array)for(var s=0,u=e[i];s<u.length;s++){var c=u[s];o.append(i,c)}else o.append(i,e[i]);n=o.toString()}var l=t.split("?");return r||l.length<2?l[0]+"?"+n:t+"&"+n};function y(t,e){return encodeURIComponent(t)+"="+encodeURIComponent("object"===typeof e?JSON.stringify(e):""+e)}var v=d.factory;v.default=d.factory;e.a=v},17:function(t,e,r){"use strict";r.r(e);var n=r(1);function o(t){return Object(n.a)(`/ajax/illust/${t}/pages`).options({credentials:"same-origin",cache:"no-cache"}).content("application/json").errorType("json").resolve(t=>t.json(t=>t.body)).get()}function i(t){const e=t.lastIndexOf(".");return t.slice(e+1)}function s(t){return new Promise((e,r)=>{GM_xmlhttpRequest({url:t,responseType:"blob",method:"GET",headers:{referer:t},onload:t=>e(t.response),onerror:r})})}function a(t,e){const r=document.createElement("a");r.style.display="none",r.href=URL.createObjectURL(t),r.download=e,r.click(),setTimeout(()=>{window.URL.revokeObjectURL(r.href)},100)}function u(t){return 2===t.illustType?async function(t){const{id:e,title:r,userName:o}=t,i=await function(t){return Object(n.a)(`/ajax/illust/${t}/ugoira_meta`).options({credentials:"same-origin",cache:"no-cache"}).content("application/json").errorType("json").resolve(t=>t.json(t=>t.body)).get()}(e);a(await s(i.originalSrc),`${o} - ${r}.zip`)}(t):t.pageCount>1?async function(t){const{id:e,title:r,userName:n}=t,u=await o(e),c=new unsafeWindow.JSZip;for(const[t,e]of u.entries()){const o=e.urls.original,a=i(o),u=String(t).padStart(3,"000"),l=`${n} - ${r}[${u}].${a}`,f=await s(o);c.file(l,f)}a(await c.generateAsync({type:"blob"}),`${n} - ${r}.zip`)}(t):async function(t){const{id:e,title:r,userName:n}=t,[u]=await o(e),c=u.urls.original,l=await s(c),f=i(c);a(l,`${n} - ${r}.${f}`)}(t)}const c=new MessageChannel,{port1:l,port2:f}=c;l.addEventListener("message",t=>{const e=t.data;if(!1!==function(t){return t&&"object"===typeof t&&"string"===typeof t.type}(e))switch(e.type){case"CONNECTION-SUCCESS":return void function(t){const e=document.createElement("script");e.src=t,document.body.appendChild(e)}("https://unpkg.com/jszip@3.1.5/dist/jszip.min.js");case"DOWNLOAD_REQUEST":return void u(e.payload);default:console.error("Unknown Action",e)}}),l.start(),window.postMessage({type:"CONNECTION-REQUEST",id:"download"},location.origin,[f])}});