/*
// ==UserScript==
// @name         cockpit download addon
// @description  cockpit download helper addon.
// @version      4.1.0-alpha.2
// @author       8th713
// @homepage     https://github.com/8th713/cockpit-for-pixiv
// @supportURL   https://github.com/8th713/cockpit-for-pixiv/issues
// @license      MIT
// @namespace    http://github.com/8th713
// @match        https://www.pixiv.net/*
// @exclude      https://www.pixiv.net/novel/*
// @grant        unsafeWindow
// @grant        GM_xmlhttpRequest
// @connect      i.pximg.net
// @connect      pixiv.net
// ==/UserScript==
*/!function(t){var e={};function o(n){if(e[n])return e[n].exports;var r=e[n]={i:n,l:!1,exports:{}};return t[n].call(r.exports,r,r.exports,o),r.l=!0,r.exports}o.m=t,o.c=e,o.d=function(t,e,n){o.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},o.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"===typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)o.d(n,r,function(e){return t[e]}.bind(null,r));return n},o.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return o.d(e,"a",e),e},o.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},o.p="",o(o.s=14)}({14:function(t,e,o){"use strict";o.r(e);const n=o(2).a.create({credentials:"same-origin",cache:"no-cache"});async function r(t){return(await n.get(`/ajax/illust/${t}/pages`).json()).body}function s(t){const e=t.lastIndexOf(".");return t.slice(e+1)}function i(t){return new Promise((e,o)=>{GM_xmlhttpRequest({url:t,responseType:"blob",method:"GET",headers:{referer:t},onload:t=>e(t.response),onerror:o})})}function a(t,e){const o=document.createElement("a");o.style.display="none",o.href=URL.createObjectURL(t),o.download=e,o.click(),setTimeout(()=>{window.URL.revokeObjectURL(o.href)},100)}function c(t){return 2===t.illustType?async function(t){const{id:e,title:o,userName:r}=t,s=await async function(t){return(await n.get(`/ajax/illust/${t}/ugoira_meta`).json()).body}(e);a(await i(s.originalSrc),`${r} - ${o}.zip`)}(t):t.pageCount>1?async function(t){const{id:e,title:o,userName:n}=t,c=await r(e),u=new unsafeWindow.JSZip;for(const[t,e]of c.entries()){const r=e.urls.original,a=s(r),c=String(t).padStart(3,"000"),h=`${n} - ${o}[${c}].${a}`,l=await i(r);u.file(h,l)}a(await u.generateAsync({type:"blob"}),`${n} - ${o}.zip`)}(t):async function(t){const{id:e,title:o,userName:n}=t,[c]=await r(e),u=c.urls.original,h=await i(u),l=s(u);a(h,`${n} - ${o}.${l}`)}(t)}const u=`${GM_info.script.name} - ${GM_info.script.version}`,h=new MessageChannel,{port1:l,port2:p}=h;l.addEventListener("message",t=>{const e=t.data;if(!1!==function(t){return t&&"object"===typeof t&&"string"===typeof t.type}(e))switch(e.type){case"CONNECTION-SUCCESS":return void function(t){const e=document.createElement("script");e.src=t,document.body.appendChild(e)}("https://unpkg.com/jszip@3.1.5/dist/jszip.min.js");case"DOWNLOAD_REQUEST":return void c(e.payload);default:console.error(u+" Unknown Action",e)}}),l.start(),window.postMessage({type:"CONNECTION-REQUEST",id:"download"},location.origin,[p])},2:function(t,e,o){"use strict";
/*! MIT License Â© Sindre Sorhus */const n=t=>"undefined"!==typeof self&&self&&t in self?self[t]:"undefined"!==typeof window&&window&&t in window?window[t]:"undefined"!==typeof global&&global&&t in global?global[t]:"undefined"!==typeof globalThis&&globalThis?globalThis[t]:void 0,r=n("document"),s=n("Headers"),i=n("Response"),a=n("ReadableStream"),c=n("fetch"),u=n("AbortController"),h=n("FormData"),l=t=>null!==t&&"object"===typeof t,p="function"===typeof u,f="function"===typeof a,d="function"===typeof h,y=(...t)=>{let e={};for(const o of t)if(Array.isArray(o))Array.isArray(e)||(e=[]),e=[...e,...o];else if(l(o))for(let[t,n]of Object.entries(o))l(n)&&Reflect.has(e,t)&&(n=y(e[t],n)),e={...e,[t]:n};return e},w=["get","post","put","patch","head","delete"],b={json:"application/json",text:"text/*",formData:"multipart/form-data",arrayBuffer:"*/*",blob:"*/*"},m=new Set(["get","put","head","delete","options","trace"]),_=new Set([408,413,429,500,502,503,504]),g=new Set([413,429,503]);class S extends Error{constructor(t){super(t.statusText),this.name="HTTPError",this.response=t}}class j extends Error{constructor(){super("Request timed out"),this.name="TimeoutError"}}const E=t=>new Promise((e,o)=>{t>2147483647?o(new RangeError("The `timeout` option cannot be greater than 2147483647")):setTimeout(e,t)}),R=(t,e,o)=>new Promise((n,r)=>{t.then(n).catch(r),E(e).then(()=>{p&&o.abort(),r(new j)}).catch(r)}),T=t=>w.includes(t)?t.toUpperCase():t;class U{constructor(t,{timeout:e=1e4,hooks:o,throwHttpErrors:n=!0,searchParams:a,json:c,...l}){if(this._retryCount=0,this._options={method:"get",credentials:"same-origin",retry:2,...l},p&&(this.abortController=new u,this._options.signal&&this._options.signal.addEventListener("abort",()=>{this.abortController.abort()}),this._options.signal=this.abortController.signal),this._options.method=T(this._options.method),this._options.prefixUrl=String(this._options.prefixUrl||""),this._input=String(t||""),this._options.prefixUrl&&this._input.startsWith("/"))throw new Error("`input` must not begin with a slash when using `prefixUrl`");if(this._options.prefixUrl&&!this._options.prefixUrl.endsWith("/")&&(this._options.prefixUrl+="/"),this._input=this._options.prefixUrl+this._input,a){const t=new URL(this._input,r&&r.baseURI);if("string"===typeof a||URLSearchParams&&a instanceof URLSearchParams)t.search=a;else{if(!Object.values(a).every(t=>"number"===typeof t||"string"===typeof t))throw new Error("The `searchParams` option must be either a string, `URLSearchParams` instance or an object with string and number values");t.search=new URLSearchParams(a).toString()}this._input=t.toString()}this._timeout=e,this._hooks=y({beforeRequest:[],afterResponse:[]},o),this._throwHttpErrors=n;const w=new s(this._options.headers||{});if((d&&this._options.body instanceof h||this._options.body instanceof URLSearchParams)&&w.has("content-type"))throw new Error(`The \`content-type\` header cannot be used with a ${this._options.body.constructor.name} body. It will be set automatically.`);if(c){if(this._options.body)throw new Error("The `json` option cannot be used with the `body` option");w.set("content-type","application/json"),this._options.body=JSON.stringify(c)}this._options.headers=w;const _=async()=>{await E(1);let t=await this._fetch();for(const e of this._hooks.afterResponse){const o=await e(t.clone());o instanceof i&&(t=o)}if(!t.ok&&this._throwHttpErrors)throw new S(t);if(this._options.onDownloadProgress){if("function"!==typeof this._options.onDownloadProgress)throw new TypeError("The `onDownloadProgress` option must be a function");if(!f)throw new Error("Streams are not supported in your environment. `ReadableStream` is missing.");return this._stream(t.clone(),this._options.onDownloadProgress)}return t},g=m.has(this._options.method.toLowerCase())?this._retry(_):_();for(const[t,e]of Object.entries(b))g[t]=async()=>(w.set("accept",e),(await g).clone()[t]());return g}_calculateRetryDelay(t){if(this._retryCount++,this._retryCount<this._options.retry&&!(t instanceof j)){if(t instanceof S){if(!_.has(t.response.status))return 0;const e=t.response.headers.get("Retry-After");if(e&&g.has(t.response.status)){let t=Number(e);return Number.isNaN(t)?t=Date.parse(e)-Date.now():t*=1e3,t}if(413===t.response.status)return 0}return.3*2**(this._retryCount-1)*1e3}return 0}async _retry(t){try{return await t()}catch(e){const o=this._calculateRetryDelay(e);if(0!==o&&this._retryCount>0)return await E(o),this._retry(t);if(this._throwHttpErrors)throw e}}async _fetch(){for(const t of this._hooks.beforeRequest)await t(this._options);return!1===this._timeout?c(this._input,this._options):R(c(this._input,this._options),this._timeout,this.abortController)}_stream(t,e){const o=Number(t.headers.get("content-length"))||0;let n=0;return new i(new a({start(r){const s=t.body.getReader();e&&e({percent:0,transferredBytes:0,totalBytes:o},new Uint8Array),async function t(){const{done:i,value:a}=await s.read();i?r.close():(e&&(n+=a.byteLength,e({percent:0===o?0:n/o,transferredBytes:n,totalBytes:o},a)),r.enqueue(a),t())}()}}))}}const x=(...t)=>{for(const e of t)if((!l(e)||Array.isArray(e))&&"undefined"!==typeof e)throw new TypeError("The `options` argument must be an object");return y({},...t)},C=t=>{const e=(e,o)=>new U(e,x(t,o));for(const o of w)e[o]=(e,n)=>new U(e,x(t,n,{method:o}));return e.create=t=>C(x(t)),e.extend=e=>C(x(t,e)),e};e.a=C()}});